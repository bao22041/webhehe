<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω sinh vi√™n</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <style>
        body{
            background: radial-gradient(circle at top left, #7c3aed, transparent 45%),
                        radial-gradient(circle at bottom right, #06b6d4, transparent 45%),
                        linear-gradient(135deg, #0f172a, #111827);
            min-height:100vh;
            color:#e5e7eb;
        }
        .glass{
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(14px);
            border-radius: 18px;
            box-shadow: 0 18px 45px rgba(0,0,0,.35);
            animation: popIn .5s ease;
        }
        @keyframes popIn{
            from{opacity:0; transform: translateY(16px) scale(.98);}
            to{opacity:1; transform: translateY(0) scale(1);}
        }
        .title{ font-weight:800; letter-spacing:.4px; }
        .badge-soft{
            background: rgba(99,102,241,.18);
            border: 1px solid rgba(99,102,241,.25);
            color:#c7d2fe;
            border-radius: 999px;
            padding: .35rem .7rem;
            font-size: .85rem;
        }
        .form-control{
            border-radius: 14px;
            background: rgba(255,255,255,.06);
            border: 1px solid rgba(255,255,255,.10);
            color:#e5e7eb;
        }
        .form-control::placeholder{ color: rgba(229,231,235,.65); }
        .form-control:focus{
            box-shadow: 0 0 0 .2rem rgba(99,102,241,.25);
            border-color: rgba(99,102,241,.55);
        }
        .table{
            color:#e5e7eb;
            border-color: rgba(255,255,255,.12);
        }
        .table thead th{
            background: rgba(99,102,241,.22);
            color:#e5e7eb;
            border-color: rgba(255,255,255,.12);
        }
        .table tbody tr{
            transition: transform .15s ease, background .15s ease;
        }
        .table tbody tr:hover{
            background: rgba(255,255,255,.06);
            transform: translateY(-1px);
        }
        .btn{ border-radius: 14px; border:none; }
        .btn-primary{ background: linear-gradient(135deg,#6366f1,#a855f7); }
        .btn-warning{ color:#111827; background: linear-gradient(135deg,#fbbf24,#f59e0b); }
        .btn-danger{ background: linear-gradient(135deg,#ef4444,#b91c1c); }
        .btn i{ margin-right:6px; }
        .hint{ font-size:.9rem; color: rgba(229,231,235,.75); }

        .toastx{
            position: fixed; top: 18px; right: 18px; z-index: 9999;
            min-width: 260px; display:none; padding: 12px 14px;
            border-radius: 14px;
            background: rgba(16,185,129,.16);
            border: 1px solid rgba(16,185,129,.35);
            color:#d1fae5;
            box-shadow: 0 18px 45px rgba(0,0,0,.35);
            animation: slideIn .28s ease;
        }
        @keyframes slideIn{
            from{opacity:0; transform: translateX(12px);}
            to{opacity:1; transform: translateX(0);}
        }
        .overlay{
            position: fixed; inset: 0;
            display:none; align-items:center; justify-content:center;
            background: rgba(0,0,0,.35);
            z-index: 9998;
        }
        .spinner{
            width: 56px; height: 56px;
            border-radius: 50%;
            border: 5px solid rgba(255,255,255,.22);
            border-top-color: rgba(99,102,241,.9);
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin{ to{ transform: rotate(360deg);} }
        .flash{ animation: flash 1.2s ease; }
        @keyframes flash{
            0%{ background: rgba(34,197,94,.22); }
            100%{ background: transparent; }
        }
    </style>
</head>

<body class="container py-5">

<div class="glass p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
            <div class="d-flex align-items-center gap-2">
                <h3 class="title m-0">üéì Qu·∫£n l√Ω sinh vi√™n</h3>
                <span class="badge-soft">ƒê√∫ng chu·∫©n ƒë·ªÅ ch·∫•m ƒëi·ªÉm</span>
            </div>
            <div class="hint mt-1">Th√™m / s·ª≠a / x√≥a / t√¨m ki·∫øm ‚Äì API theo ƒë√∫ng annotation th·∫ßy y√™u c·∫ßu.</div>
        </div>
        <button class="btn btn-primary" onclick="loadStudents()">
            <i class="fa-solid fa-rotate-right"></i> T·∫£i l·∫°i
        </button>
    </div>

    <input type="text" id="search" class="form-control mb-3"
           placeholder="üîç T√¨m theo t√™n..." onkeyup="searchStudent()">

    <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
            <thead>
            <tr>
                <th style="width:90px;">ID</th>
                <th>T√™n</th>
                <th>Email</th>
                <th style="width:220px;">H√†nh ƒë·ªông</th>
            </tr>
            </thead>
            <tbody id="studentTable"></tbody>
        </table>
    </div>

    <hr class="border border-white border-opacity-10">

    <h5 class="mb-3">‚ûï Th√™m sinh vi√™n</h5>
    <div class="row g-2">
        <div class="col-md-2">
            <input id="id" class="form-control" placeholder="ID (nh·∫≠p tay)">
        </div>
        <div class="col-md-4">
            <input id="name" class="form-control" placeholder="T√™n">
        </div>
        <div class="col-md-4">
            <input id="email" class="form-control" placeholder="Email">
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-primary" onclick="addStudent()">
                <i class="fa-solid fa-plus"></i> Th√™m
            </button>
        </div>
    </div>
</div>

<div class="toastx" id="toastx">‚úÖ Th√†nh c√¥ng!</div>

<div class="overlay" id="overlay">
    <div class="spinner"></div>
</div>

<!-- Modal Update -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: rgba(17,24,39,.95); border:1px solid rgba(255,255,255,.12); border-radius:18px;">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white">‚úèÔ∏è C·∫≠p nh·∫≠t sinh vi√™n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-0">
                <div class="mb-2">
                    <label class="form-label text-white-50">ID</label>
                    <input id="editId" class="form-control" disabled>
                </div>
                <div class="mb-2">
                    <label class="form-label text-white-50">T√™n</label>
                    <input id="editName" class="form-control" placeholder="T√™n">
                </div>
                <div class="mb-2">
                    <label class="form-label text-white-50">Email</label>
                    <input id="editEmail" class="form-control" placeholder="Email">
                </div>
                <div class="hint">L∆∞u √Ω: Update theo ƒë·ªÅ = POST /update/{id}.</div>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius:14px;">ƒê√≥ng</button>
                <button class="btn btn-warning" onclick="saveEdit()">
                    <i class="fa-solid fa-floppy-disk"></i> L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API = "/api/students";
let lastUpdatedId = null;

function setLoading(isLoading){
    document.getElementById("overlay").style.display = isLoading ? "flex" : "none";
}
function toast(msg){
    const t = document.getElementById("toastx");
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=> t.style.display="none", 1800);
}

function render(data) {
    let html = "";
    data.forEach(s => {
        const flash = (lastUpdatedId === s.id) ? "flash" : "";
        html += `
        <tr class="${flash}">
            <td>${s.id}</td>
            <td>${escapeHtml(s.name ?? "")}</td>
            <td>${escapeHtml(s.email ?? "")}</td>
            <td class="d-flex gap-2 justify-content-center flex-wrap">
                <button class="btn btn-warning btn-sm"
                        onclick="openEdit(${s.id}, '${jsStr(s.name)}', '${jsStr(s.email)}')">
                    <i class="fa-solid fa-pen-to-square"></i> S·ª≠a
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteStudent(${s.id})">
                    <i class="fa-solid fa-trash"></i> X√≥a
                </button>
            </td>
        </tr>`;
    });
    document.getElementById("studentTable").innerHTML = html;
    lastUpdatedId = null;
}

function loadStudents() {
    setLoading(true);
    fetch(API)
        .then(res => res.json())
        .then(data => render(data))
        .finally(()=> setLoading(false));
}

function addStudent() {
    const id = document.getElementById("id").value.trim();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();

    if(!id || !name || !email){
        toast("‚ö†Ô∏è Nh·∫≠p ƒë·ªß ID / T√™n / Email");
        return;
    }

    const student = { id: Number(id), name, email };

    setLoading(true);
    fetch(API, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(student)
    }).then(res => {
        if (!res.ok) { toast("‚ùå ID ƒë√£ t·ªìn t·∫°i ho·∫∑c l·ªói"); return; }
        toast("‚úÖ Th√™m th√†nh c√¥ng");
        clearAddForm();
        loadStudents();
    }).finally(()=> setLoading(false));
}

/* ‚úÖ Theo ƒë·ªÅ: X√ìA = POST /delete/{id} */
function deleteStudent(id) {
    if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a?")) return;

    setLoading(true);
    fetch(`${API}/delete/${id}`, { method: "POST" })
        .then(res => {
            if(!res.ok){ toast("‚ùå X√≥a th·∫•t b·∫°i"); return; }
            toast("üóëÔ∏è ƒê√£ x√≥a");
            loadStudents();
        })
        .finally(()=> setLoading(false));
}

function searchStudent() {
    const name = document.getElementById("search").value;
    fetch(`${API}/search?name=${encodeURIComponent(name)}`)
        .then(res => res.json())
        .then(data => render(data));
}

/* ===== UPDATE ===== */
let editModal = null;

function openEdit(id, name, email){
    document.getElementById("editId").value = id;
    document.getElementById("editName").value = name;
    document.getElementById("editEmail").value = email;

    editModal = bootstrap.Modal.getOrCreateInstance(document.getElementById("editModal"));
    editModal.show();
}

/* ‚úÖ Theo ƒë·ªÅ: UPDATE = POST /update/{id} */
function saveEdit(){
    const id = Number(document.getElementById("editId").value);
    const name = document.getElementById("editName").value.trim();
    const email = document.getElementById("editEmail").value.trim();

    if(!name || !email){
        toast("‚ö†Ô∏è T√™n v√† Email kh√¥ng ƒë∆∞·ª£c r·ªóng");
        return;
    }

    setLoading(true);
    fetch(`${API}/update/${id}`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ id, name, email })
    }).then(res => {
        if(!res.ok){ toast("‚ùå C·∫≠p nh·∫≠t th·∫•t b·∫°i"); return; }
        toast("‚úèÔ∏è C·∫≠p nh·∫≠t th√†nh c√¥ng");
        lastUpdatedId = id;
        editModal?.hide();
        loadStudents();
    }).finally(()=> setLoading(false));
}

/* Helpers */
function clearAddForm(){
    document.getElementById("id").value = "";
    document.getElementById("name").value = "";
    document.getElementById("email").value = "";
}
function escapeHtml(str){
    return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
}
function jsStr(str){
    return String(str ?? "").replaceAll("\\", "\\\\").replaceAll("'", "\\'");
}

loadStudents();
</script>

</body>
</html>
